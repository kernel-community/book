const fs = require('fs');
const path = require('path');
const matter = require('gray-matter');

const CONTENT_ROOT = path.join(process.cwd(), 'content');
const OUTPUT_PATH = path.join(process.cwd(), 'src', 'data', 'content-index.json');
const LOADERS_PATH = path.join(process.cwd(), 'src', 'data', 'content-loaders.ts');

const mdxFiles = [];

const walk = (dir) => {
  const entries = fs.readdirSync(dir, { withFileTypes: true });
  for (const entry of entries) {
    const fullPath = path.join(dir, entry.name);
    if (entry.isDirectory()) {
      walk(fullPath);
    } else if (entry.isFile() && entry.name.endsWith('.mdx')) {
      mdxFiles.push(fullPath);
    }
  }
};

walk(CONTENT_ROOT);

const entries = mdxFiles.map((filePath) => {
  const relativePath = path.relative(CONTENT_ROOT, filePath);
  const parts = relativePath.split(path.sep);
  const locale = parts[0];
  const topSection = parts[1] || null;

  const raw = fs.readFileSync(filePath, 'utf8');
  const parsed = matter(raw);

  const headingMatch = parsed.content.match(/^#\s+(.+)$/m);
  const derivedTitle =
    parsed.data.title ||
    (headingMatch ? headingMatch[1] : null) ||
    parts[parts.length - 1].replace(/(index)?\.mdx$/, '');

  const slugWithLocale =
    '/' +
    relativePath
      .replace(/\\/g, '/')
      .replace(/(index)?\.mdx$/, '')
      .replace(/\/$/, '');

  const rawSlug = slugWithLocale.replace(/^\/[\w-]{2}\//, '/');
  const slugPart = slugWithLocale.split('/').filter(Boolean).slice(-1)[0];
  const order = Number.isFinite(parsed.data.order) ? parsed.data.order : null;

  return {
    locale,
    topSection,
    title: derivedTitle,
    slug: slugWithLocale,
    rawSlug,
    slugPart,
    order,
    path: relativePath,
  };
});

fs.mkdirSync(path.dirname(OUTPUT_PATH), { recursive: true });
fs.writeFileSync(OUTPUT_PATH, JSON.stringify(entries, null, 2));
console.log(`Wrote ${entries.length} entries to ${OUTPUT_PATH}`);

// Also emit a loader manifest with static import paths so bundlers can include MDX.
const loaderEntries = entries
  .map(
    (entry) =>
      `  "${entry.slug}": () => import("../../content/${entry.path.replace(/\\\\/g, '/')}"),`
  )
  .join('\n');

const loaderFile = `// Auto-generated by scripts/build-content-index.js. Do not edit manually.
// Maps slug to a lazy MDX import. Keep paths static for bundlers.

export const contentLoaders: Record<string, () => Promise<{ default: React.ComponentType }>> = {
${loaderEntries}
};
`;

fs.writeFileSync(LOADERS_PATH, loaderFile);
console.log(`Wrote loader map to ${LOADERS_PATH}`);

// Also build search index
console.log('\nBuilding search index...');
require('./build-search-index.js');

